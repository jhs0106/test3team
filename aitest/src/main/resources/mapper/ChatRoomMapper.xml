<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.sm.app.repository.ChatRoomRepository">

    <select id="getWaitingRooms" resultType="edu.sm.app.dto.ChatRoomDto">
        SELECT room_id, cust_id, admin_id, status, created_at, closed_at,
               latitude, longitude, location_updated_at
        FROM chatroom
        WHERE status = 'waiting'
        ORDER BY created_at ASC
    </select>

    <select id="getAllRooms" resultType="edu.sm.app.dto.ChatRoomDto">
        SELECT room_id, cust_id, admin_id, status, created_at, closed_at,
               latitude, longitude, location_updated_at
        FROM chatroom
        ORDER BY created_at DESC
    </select>

    <select id="selectById" resultType="edu.sm.app.dto.ChatRoomDto">
        SELECT room_id, cust_id, admin_id, status, created_at, closed_at,
               latitude, longitude, location_updated_at
        FROM chatroom
        WHERE room_id = #{roomId}
    </select>

    <select id="getActiveByCustId" resultType="edu.sm.app.dto.ChatRoomDto">
        SELECT room_id, cust_id, admin_id, status, created_at, closed_at,
               latitude, longitude, location_updated_at
        FROM chatroom
        WHERE cust_id = #{custId} AND status IN ('waiting', 'active')
        ORDER BY created_at DESC
            LIMIT 1
    </select>

    <update id="assignAdmin">
        UPDATE chatroom
        SET admin_id = #{adminId}, status = 'active'
        WHERE room_id = #{roomId}
    </update>

    <update id="closeRoom">
        UPDATE chatroom
        SET status = 'closed', closed_at = CURRENT_TIMESTAMP
        WHERE room_id = #{roomId}
    </update>

    <insert id="createRoom">
        INSERT INTO chatroom (cust_id, status)
        VALUES (#{custId}, 'waiting')
    </insert>

    <!-- ⭐ 8단계: 위치 정보 업데이트 -->
    <update id="updateLocation">
        UPDATE chatroom
        SET latitude = #{latitude},
            longitude = #{longitude},
            location_updated_at = CURRENT_TIMESTAMP
        WHERE room_id = #{roomId}
    </update>

</mapper>