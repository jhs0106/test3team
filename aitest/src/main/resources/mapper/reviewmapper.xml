<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.sm.app.repository.ReviewRepository">

    <resultMap id="memberReviewResultMap" type="edu.sm.app.dto.MemberReview">
        <id property="reviewId" column="review_id" />
        <result property="memberNo" column="member_no" />
        <result property="memberName" column="member_name" />
        <result property="review" column="review" />
        <result property="sentiment" column="sentiment" />
        <result property="createdAt" column="created_at" />
    </resultMap>

    <insert id="insertReview" parameterType="edu.sm.app.dto.MemberReview" useGeneratedKeys="true" keyProperty="reviewId">
        INSERT INTO decision_member_review
            (member_no, review, sentiment, created_at)
        VALUES
            (#{memberNo}, #{review}, #{sentiment}, #{createdAt})
    </insert>

    <select id="findRecentReviews" parameterType="int" resultMap="memberReviewResultMap">
        SELECT r.review_id,
               r.member_no,
               m.name AS member_name,
               r.review,
               r.sentiment,
               r.created_at
        FROM decision_member_review r
                 JOIN decision_member m ON r.member_no = m.member_no
        ORDER BY r.created_at DESC
            LIMIT #{limit}
    </select>
</mapper>